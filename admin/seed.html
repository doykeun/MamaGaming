<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seed Data - MamaGaming Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-dark text-white p-5">
    <div class="container">
        <h1>Seed Data to Firestore</h1>
        <p>Halaman ini digunakan untuk mengupload data dari <code>data.js</code> ke Firestore.</p>
        
        <!-- Auth Section -->
        <div id="auth-section" class="card p-3 mb-3 d-none">
            <h5>Login Diperlukan</h5>
            <p class="small text-muted">Anda harus login untuk menulis ke database.</p>
            <div class="mb-2">
                <input type="email" id="email" class="form-control mb-2" placeholder="Email Admin">
                <input type="password" id="password" class="form-control mb-2" placeholder="Password">
                <button id="btn-login" class="btn btn-secondary w-100">Login</button>
            </div>
            <div id="login-msg" class="text-danger small"></div>
        </div>

        <div id="action-section" class="d-none">
             <p class="text-success fw-bold"><i class="fa fa-check"></i> Terhubung sebagai Admin.</p>
             <button id="btn-seed" class="btn btn-primary btn-lg">Mulai Upload Data</button>
        </div>
        
        <div id="log" class="mt-4 p-3 border border-secondary rounded" style="max-height: 400px; overflow-y: auto; font-family: monospace;"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/data.js"></script>
    
    <script>
        // Init Firebase
        firebase.initializeApp(window.firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const authSection = document.getElementById('auth-section');
        const actionSection = document.getElementById('action-section');
        const loginMsg = document.getElementById('login-msg');

        function log(msg, type='text-white') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('log').append(div);
        }

        // Login Logic
        document.getElementById('btn-login').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                loginMsg.textContent = '';
            } catch (e) {
                loginMsg.textContent = 'Login Gagal: ' + e.message;
            }
        });

        document.getElementById('btn-seed').addEventListener('click', async () => {
            if (!auth.currentUser) {
                log('Error: Sesi habis. Silakan login ulang.', 'text-danger');
                return;
            }

            if(typeof gamesData === 'undefined') {
                log('Error: gamesData tidak ditemukan.', 'text-danger');
                return;
            }

            log('Memulai proses seeding...', 'text-info');
            
            const games = Object.values(gamesData);
            
            for (const game of games) {
                try {
                    log(`Memproses game: ${game.title}...`);
                    
                    // 1. Upload Game Data (exclude nominal array which goes to subcollection)
                    const gameRef = db.collection('games').doc(game.slug);
                    
                    const gamePayload = {
                        slug: game.slug,
                        title: game.title,
                        publisher: game.publisher,
                        description: game.description,
                        image: game.image,
                        zoneRequired: game.zoneRequired,
                        fields: game.fields
                    };

                    await gameRef.set(gamePayload, { merge: true });
                    log(`✓ Game ${game.title} berhasil disimpan.`);

                    // 2. Upload Nominal Data to Subcollection
                    if (game.nominal && game.nominal.length > 0) {
                        const batch = db.batch();
                        
                        game.nominal.forEach((nom, index) => {
                            // Gunakan code sebagai Doc ID agar tidak duplikat
                            const nomRef = gameRef.collection('nominal').doc(nom.code);
                            batch.set(nomRef, {
                                code: nom.code,
                                label: nom.label,
                                price: nom.price,
                                order: index // Tambahkan field order untuk sorting
                            });
                        });

                        await batch.commit();
                        log(`✓ ${game.nominal.length} nominal berhasil diupload untuk ${game.title}.`);
                    }

                } catch (error) {
                    log(`x Gagal memproses ${game.title}: ${error.message}`, 'text-danger');
                    console.error(error);
                }
            }
            
            log('Semua proses selesai!', 'text-success fw-bold');
        });

        // Check auth status
        auth.onAuthStateChanged(user => {
            if (user) {
                log(`Terhubung sebagai: ${user.email}`, 'text-success');
                authSection.classList.add('d-none');
                actionSection.classList.remove('d-none');
            } else {
                log('Silakan login terlebih dahulu.', 'text-warning');
                authSection.classList.remove('d-none');
                actionSection.classList.add('d-none');
            }
        });
    </script>
</body>
</html>
